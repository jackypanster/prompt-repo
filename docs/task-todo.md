# **提示词分享平台 - MVP 任务清单 (task-todo.md)**

## **0. 引言与基本原则 (Introduction & Guiding Principles)**

本文档用于追踪"提示词分享平台"MVP (Minimum Viable Product) 的开发任务。所有任务的规划与执行遵循以下核心原则：

1. **文档优先、测试优先**:  
   * 在开始编码前，确保相关的需求、架构、设计文档已清晰。  
   * 为每个功能模块或重要逻辑编写测试用例。  
   * 如果需求发生变更，必须首先更新所有相关文档 (prd.md, arch.md, design.md, impl.md, task-todo.md)，然后更新测试，最后修改代码。  
2. **原子任务与顺序执行**:  
   * 每个任务都设计为原子实现，具有高内聚性。  
   * 严格按照任务顺序执行，只有当前一个任务通过验收后，才开始下一个任务。**任务完成后，请在此文档中对应任务前使用** [x] **标记（例如：**[x] 任务 1.1**），未完成的任务使用** [ ] **标记。**  
3. **版本控制与持续集成**:  
   * 每个任务或一组紧密相关的任务完成后，应提交代码到 Git 仓库 (git commit)，并推送到远程仓库 (git push)。  
   * 每个阶段性里程碑（例如，一个模块的核心功能完成）完成后，应：  
     * 编写清晰的 CHANGELOG.md 条目。  
     * 在 Git 中打上明确的标签 (git tag)。  
     * 确保代码库在任何时候都可以方便地回滚到上一个稳定版本。  
4. **代码规范**:  
   * 每个独立的 Python 代码文件（.py）的行数（不包括空行和注释）原则上不应超过 100 行。这鼓励模块化和代码拆分。  
5. **验收标准**:  
   * 每个任务必须有明确的验收手段。  
   * 对于代码实现，应优先考虑自动化测试：  
     * **单元测试 (Unit Tests)**: 针对独立的函数或类中的业务逻辑。  
     * **集成测试 (Integration Tests)**: 针对 API 端点，测试其与数据库的交互。  
     * **命令行测试 (CLI Tests)**: 作为快速验证手段，可以使用 curl 或 HTTPie 测试 API 端点。  
   * 所有测试必须通过，才认为任务完成。  
6. **日志记录**:  
   * 在关键的业务逻辑、API 请求处理、错误捕获等位置，应添加恰当的日志记录。  
   * 日志应包含足够的信息（如时间戳、请求ID、关键变量值等），以便于追踪问题、调试和监控应用状态。  
   * FastAPI 项目可以集成标准的 Python logging 模块，并根据需要配置日志级别和输出格式。

## **第一阶段：项目初始化与基础设施 (Phase 1: Project Setup & Infrastructure)**

### [x] **任务 1.1: 初始化 FastAPI 项目与 uv 环境**

* **任务描述**: 使用 uv 创建新的 Python 虚拟环境，并初始化一个基础的 FastAPI 项目结构。安装 FastAPI, Uvicorn 等核心依赖。  
* **原子性/内聚性**: 专注于项目骨架和基础依赖的建立。  
* **验收手段**:  
  * **命令行测试**:  
    * uv venv 成功创建虚拟环境。  
    * uv sync 成功安装依赖到虚拟环境。  
    * 能够运行一个最小的 "Hello World" FastAPI 应用 (uv run uvicorn main:app --reload --port 8080) 并通过浏览器或 curl 访问。  
  * **文档**: 项目 README.md 中记录项目启动和依赖安装步骤。  
* **前置任务**: 无
* **完成状态**: ✅ 已完成并修正
  * 创建了 pyproject.toml 配置文件
  * 使用 uv sync 正确创建虚拟环境 (.venv/)
  * 依赖正确安装在虚拟环境中 (FastAPI, Uvicorn)
  * Python 解释器路径指向虚拟环境: `D:\workspace\prompt-repo\.venv\Scripts\python.exe`
  * 应用在端口 8080 上正常运行 (使用 `uv run uvicorn main:app --port 8080 --reload`)
  * 验证了所有基础端点:
    * `GET /` → `{"message":"Hello World","app":"提示词分享平台后端 MVP"}`
    * `GET /health` → `{"status":"healthy"}`
    * `GET /docs` → Swagger UI 正常显示

### [x] **任务 1.2: 配置 SQLite 数据库与 WAL 模式**

* **任务描述**: 设置本地 SQLite 数据库，启用 WAL 模式优化并发，创建完整的数据库表结构，实现数据库连接管理和初始化逻辑。  
* **原子性/内聚性**: 专注于数据持久化基础设施的建立。  
* **表结构要求**:
  * `categories` 表（分类）
  * `tags` 表（标签）
  * `prompts` 表（提示词主表）
  * `prompt_tags` 表（提示词-标签多对多关联）
  * `prompt_likes` 表（点赞记录，防重复点赞）
* **验收手段**:  
  * **代码审查**: 数据库连接逻辑封装良好，表结构符合设计文档要求。  
  * **单元测试/集成测试**:  
    * 验证数据库连接正常，WAL模式启用。  
    * 验证所有表创建成功，约束关系正确。  
    * 测试基础的 CRUD 操作。  
    * 验证外键约束和级联删除。  
  * **文档**: 在 README.md 中说明数据库初始化过程。  
* **前置任务**: 任务 1.1
* **完成状态**: ✅ 已完成
  * 创建了完整的数据库架构：
    * `app/database.py` - 数据库连接管理和WAL模式配置
    * `app/models.py` - 完整的SQLAlchemy模型定义
    * `app/crud.py` - 基础CRUD操作函数
  * 数据库功能验证：
    * ✅ SQLite WAL模式已启用
    * ✅ 外键约束正确配置
    * ✅ 所有5个表正确创建（categories, tags, prompts, prompt_tags, prompt_likes）
    * ✅ 16个索引正确创建，优化查询性能
    * ✅ 唯一约束和外键约束正常工作
  * 测试验证：
    * ✅ 11个数据库测试全部通过
    * ✅ 数据库健康检查端点正常工作 (`GET /db-health`)
    * ✅ 基础CRUD操作测试通过
  * 依赖管理：
    * ✅ 添加了SQLAlchemy 2.0和Pydantic依赖
    * ✅ 添加了pytest测试框架

### [x] **任务 1.3: 实现认证机制与权限控制**

* **任务描述**: 实现 HTTP Basic Auth 认证机制，创建管理员认证装饰器，实现 IP 限频装饰器用于防滥用。  
* **原子性/内聚性**: 专注于应用的安全访问控制。  
* **功能要求**:
  * HTTP Basic Auth 认证装饰器（保护 `/admin/*` 端点）
  * IP 限频装饰器（保护公开交互端点）
  * 环境变量配置管理员用户名密码
* **验收手段**:  
  * **单元测试**:  
    * 测试认证装饰器，验证正确和错误凭证的处理。  
    * 测试限频装饰器，验证频次控制逻辑。  
  * **集成测试**:  
    * 访问管理端点需要认证。  
    * 超出限频阈值时返回 429 错误。  
* **前置任务**: 任务 1.2

### [x] **任务 1.4: 配置模板系统与静态文件服务**

* **任务描述**: 配置 Jinja2 模板引擎，设置静态文件服务，创建基础的模板目录结构和静态资源目录。  
* **原子性/内聚性**: 专注于前端渲染基础设施的建立。  
* **功能要求**:
  * Jinja2 模板配置
  * 静态文件服务（CSS、JS、图片）
  * 基础模板文件结构
  * Tailwind CSS 和 Alpine.js 集成
* **验收手段**:  
  * **功能测试**:  
    * 访问 `/` 路径能正确返回 Jinja2 渲染的主页。  
    * 访问 `/static/` 路径能正确返回静态资源。  
    * 验证 Tailwind CSS 样式生效。  
  * **文件结构**: 创建合理的模板和静态文件目录结构。  
* **前置任务**: 任务 1.3

## **第二阶段：管理功能模块 (Phase 2: Admin Management Modules)**

### [x] **任务 2.1: 实现分类管理模块（管理端点）**

* **任务描述**: 实现分类的管理功能，包括 Pydantic 模型定义、数据库操作函数、管理端 API 端点。  
* **原子性/内聚性**: 专注于分类数据的管理功能。  
* **API 端点**:
  * `POST /admin/categories` - 创建分类
  * `GET /admin/categories` - 获取分类列表 
  * `PUT /admin/categories/{id}` - 更新分类
  * `DELETE /admin/categories/{id}` - 删除分类
* **验收手段**:  
  * **Pydantic 模型**: 定义 CategoryCreate, CategoryRead, CategoryUpdate 模型。  
  * **集成测试**:  
    * 测试所有 CRUD 操作，验证需要认证访问。  
    * 测试分类名唯一性约束。  
    * 测试删除时检查关联的提示词。  
  * **命令行测试**: curl 测试所有管理端点（带认证）。  
* **前置任务**: 任务 1.4

### [x] **任务 2.2: 实现标签管理模块（管理端点）**

* **任务描述**: 实现标签的管理功能，包括 Pydantic 模型定义、数据库操作函数、管理端 API 端点。  
* **原子性/内聚性**: 专注于标签数据的管理功能。  
* **API 端点**:
  * `POST /admin/tags` - 创建标签
  * `GET /admin/tags` - 获取标签列表
  * `PUT /admin/tags/{id}` - 更新标签
  * `DELETE /admin/tags/{id}` - 删除标签
* **验收手段**:  
  * **Pydantic 模型**: 定义 TagCreate, TagRead, TagUpdate 模型。  
  * **集成测试**:  
    * 测试所有 CRUD 操作，验证需要认证访问。  
    * 测试标签名唯一性约束。  
    * 测试删除时清理关联数据。  
  * **命令行测试**: curl 测试所有管理端点（带认证）。  
* **前置任务**: 任务 2.1

### [x] **任务 2.3: 实现提示词管理模块（管理端点）**

* **任务描述**: 实现提示词的管理功能，包括创建、更新、删除提示词，处理标签关联关系。  
* **原子性/内聚性**: 专注于提示词数据的管理功能。  
* **API 端点**:
  * `POST /admin/prompts` - 创建提示词
  * `GET /admin/prompts` - 获取管理列表
  * `PUT /admin/prompts/{id}` - 更新提示词
  * `DELETE /admin/prompts/{id}` - 删除提示词
* **验收手段**:  
  * **Pydantic 模型**: 定义 PromptCreate, PromptUpdate, PromptRead 模型。  
  * **集成测试**:  
    * 测试创建包含分类和多个标签的提示词。  
    * 测试更新提示词的标签关联（删除旧关联，添加新关联）。  
    * 测试删除提示词及其关联数据。  
    * 验证所有操作需要认证访问。  
  * **命令行测试**: curl 测试所有管理端点（带认证）。  
* **前置任务**: 任务 2.2

## **第三阶段：公开页面与浏览功能 (Phase 3: Public Pages & Browsing)**

### [x] **任务 3.1: 实现主页和提示词列表页面**

* **任务描述**: 创建主页模板，实现提示词列表的服务器端渲染，支持分页、分类筛选、标签筛选、排序功能。  
* **原子性/内聚性**: 专注于提示词浏览的核心页面。  
* **页面路由**:
  * `GET /` - 主页（提示词列表）
  * `GET /category/{name}` - 分类筛选页
  * `GET /tag/{name}` - 标签筛选页
* **功能要求**:
  * Jinja2 模板渲染提示词列表
  * 支持按复制数、点赞数排序
  * 分页导航
  * 分类和标签筛选链接
* **验收手段**:  
  * **功能测试**:  
    * 访问主页显示提示词列表。  
    * 测试分页功能正常。  
    * 测试分类和标签筛选功能。  
    * 测试排序功能（热门排序）。  
  * **响应式测试**: 验证移动端和桌面端显示正常。  
* **前置任务**: 任务 2.3

### [ ] **任务 3.2: 实现提示词详情页面**

* **任务描述**: 创建提示词详情页面，服务器端渲染 Markdown 内容，集成复制和点赞按钮。  
* **原子性/内聚性**: 专注于单个提示词的详情展示。  
* **页面路由**:
  * `GET /prompt/{id}` - 提示词详情页
* **功能要求**:
  * 服务器端 Markdown 渲染
  * 显示分类和标签信息
  * 显示统计信息（点赞数、复制数）
  * 集成复制和点赞按钮（Alpine.js）
* **验收手段**:  
  * **功能测试**:  
    * 正确显示提示词详情和 Markdown 渲染。  
    * 显示关联的分类和标签。  
    * 复制和点赞按钮显示正常。  
    * 处理不存在的提示词（404页面）。  
* **前置任务**: 任务 3.1

### [ ] **任务 3.3: 创建管理界面页面**

* **任务描述**: 创建简单的管理界面，用于博主管理提示词、分类和标签，需要认证访问。  
* **原子性/内聚性**: 专注于管理功能的用户界面。  
* **页面路由**:
  * `GET /admin` - 管理首页
  * `GET /admin/prompts` - 提示词管理页面
  * `GET /admin/categories` - 分类管理页面
  * `GET /admin/tags` - 标签管理页面
* **功能要求**:
  * 简单的 CRUD 表单界面
  * 需要 HTTP Basic Auth 认证
  * 响应式设计
* **验收手段**:  
  * **功能测试**:  
    * 未认证访问返回 401。  
    * 认证后能正常访问管理界面。  
    * 管理界面功能完整。  
* **前置任务**: 任务 3.2

## **第四阶段：交互功能与防滥用 (Phase 4: Interactive Features & Anti-Abuse)**

### [ ] **任务 4.1: 实现点赞功能与防重复机制**

* **任务描述**: 实现点赞 API，基于 IP 哈希防止重复点赞，集成前端 Alpine.js 交互。  
* **原子性/内聚性**: 专注于点赞功能的完整实现。  
* **API 端点**:
  * `POST /api/prompts/{id}/like` - 点赞操作（需要限频）
* **功能要求**:
  * IP 哈希存储防重复点赞
  * 限频保护（每 IP 每 5 分钟最多 5 次）
  * 原子性更新 like_count
  * Alpine.js 前端交互
* **验收手段**:  
  * **集成测试**:  
    * 测试正常点赞功能，验证计数增加。  
    * 测试防重复点赞机制。  
    * 测试限频功能（超出阈值返回 429）。  
  * **前端测试**: 验证按钮状态和用户反馈。  
* **前置任务**: 任务 3.3

### [ ] **任务 4.2: 实现复制功能与统计**

* **任务描述**: 实现复制统计 API，集成前端复制到剪贴板功能。  
* **原子性/内聚性**: 专注于复制功能的完整实现。  
* **API 端点**:
  * `POST /api/prompts/{id}/copy` - 复制统计（需要限频）
* **功能要求**:
  * 限频保护（每 IP 每分钟最多 10 次）
  * 原子性更新 copy_count
  * Alpine.js 复制到剪贴板
  * 用户反馈（复制成功提示）
* **验收手段**:  
  * **集成测试**:  
    * 测试复制统计功能，验证计数增加。  
    * 测试限频功能。  
  * **前端测试**: 验证复制功能和用户反馈。  
* **前置任务**: 任务 4.1

### [ ] **任务 4.3: 优化前端交互体验**

* **任务描述**: 完善前端交互细节，优化用户体验，确保响应式设计。  
* **原子性/内聚性**: 专注于前端用户体验的整体优化。  
* **功能要求**:
  * 加载状态提示
  * 错误处理和用户反馈
  * 响应式设计优化
  * 无障碍访问改进
* **验收手段**:  
  * **用户体验测试**: 验证各种设备和浏览器的兼容性。  
  * **性能测试**: 页面加载速度和交互响应速度。  
* **前置任务**: 任务 4.2

## **第五阶段：错误处理、优化与完善 (Phase 5: Error Handling, Optimization & Polish)**

### [ ] **任务 5.1: 实现全局错误处理机制**

* **任务描述**: 配置 FastAPI 的全局异常处理器，统一错误响应格式，完善日志记录。  
* **原子性/内聚性**: 专注于应用的错误处理和响应一致性。  
* **功能要求**:
  * 统一的错误响应格式
  * 不同类型异常的处理（Pydantic、数据库、业务逻辑）
  * 完善的日志记录系统
  * 敏感信息保护
* **验收手段**:  
  * **集成测试**:  
    * 故意触发各种错误类型，验证响应格式统一。  
    * 验证日志记录完整。  
* **前置任务**: 任务 4.3

### [ ] **任务 5.2: 性能优化与数据库索引**

* **任务描述**: 为常用查询添加数据库索引，优化查询性能，实现基础缓存机制。  
* **原子性/内聚性**: 专注于应用性能优化。  
* **功能要求**:
  * 关键字段建立索引
  * 查询性能优化
  * 分类标签数据缓存（可选）
  * 数据库连接优化
* **验收手段**:  
  * **性能测试**: 验证关键查询的性能指标。  
  * **代码审查**: 确认索引创建正确，缓存逻辑合理。  
* **前置任务**: 任务 5.1

### [ ] **任务 5.3: 代码审查与重构**

* **任务描述**: 全面审查代码质量，确保遵循 100 行/文件原则，进行必要的重构和优化。  
* **原子性/内聚性**: 专注于代码质量和项目规范。  
* **功能要求**:
  * 代码文件行数检查
  * 代码风格和规范检查
  * 模块化和解耦优化
  * 测试覆盖率检查
* **验收手段**:  
  * **代码审查**: 检查代码行数、风格和规范。  
  * **静态分析**: 运行代码质量检查工具。  
  * **测试覆盖率**: 确保核心功能测试覆盖充分。  
* **前置任务**: 任务 5.2

### [ ] **任务 5.4: 部署准备与文档完善**

* **任务描述**: 准备生产部署配置，完善项目文档，编写部署指南。  
* **原子性/内聚性**: 专注于项目部署和文档完整性。  
* **功能要求**:
  * 生产环境配置
  * 环境变量管理
  * 部署脚本或说明
  * 完整的项目文档
* **验收手段**:  
  * **部署测试**: 验证在新环境中的部署过程。  
  * **文档审查**: 确认所有文档内容准确且最新。  
  * **用户测试**: 端到端的功能验证。  
* **前置任务**: 任务 5.3

## **附注：持续性流程 (Ongoing Processes)**

以下流程应在整个开发周期中持续进行：

* **编写单元测试和集成测试**: 伴随每个功能模块的开发同步进行。  
* **代码提交与版本控制**: 频繁提交有意义的变更到 Git，编写清晰的 commit message。  
* **文档同步更新**: 任何代码或设计上的调整，都应立即反映到相关文档中。  
* **Changelog 记录**: 在每个阶段性成果或重要特性发布后，更新 CHANGELOG.md。